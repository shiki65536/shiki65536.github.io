---
layout: default
title: "Jest Mock Leaking Cost Me an Afternoon"
date: Sat, 15 Nov 2025 05:48:32 +0000
excerpt: "This week I hit a particularly"
link: "https://medium.com/@shiki65536/jest-mock-leaking-cost-me-an-afternoon-396a2eef3a54?source=rss-374d8f1302a3------2"
image: "https://cdn-images-1.medium.com/max/717/1*Px7vyFw9AwOL-CcCdzaM4w.jpeg"
tags: ["unittest", "troubleshooting", "debugging", "jest"]
---
This week I hit a particularly nasty bug where tests passed individually but failed in the suite. Took me an entire afternoon to realize it was mock leaking. Writing this down for futureÂ me.The Symptom// Test 1: âœ… PASSdescribe(&#39;controlled load stays as TIME_OF_USE_CONT_LOAD&#39;, () =&gt; { it(&#39;should not map timezone&#39;, () =&gt; { jest.spyOn(module, &#39;getPricingModelFrom&#39;) .mockReturnValue(&#39;TIME_OF_USE_CONT_LOAD&#39;);  const result = planElectricityContractFrom(â€¦); expect(result.timeZone).toBeUndefined(); });});// Test 2: âŒ FAILdescribe(&#39;normal TIME_OF_USE&#39;, () =&gt; { it(&#39;should map timezone from tariff&#39;, () =&gt; { const result = planElectricityContractFrom(â€¦); expect(result.pricingModel).toEqual(&#39;TIME_OF_USE&#39;); // Expected: &quot;TIME_OF_USE&quot; // Received: &quot;TIME_OF_USE_CONT_LOAD&quot; â† wait, what? });});Root CauseTest 1â€™s mock wasnâ€™t cleaned up and leaked into TestÂ 2:Test 1 runs â†’ Mock getPricingModelFrom()  â†’ Test 1 ends (but mock still active!) â†’ Test 2 runs (uses Test 1â€™s mock) â†’ Test 2 explodesÂ ğŸ’¥The FixAdd `afterEach` to clean upÂ mocks:describe(&#39;pricing model tests&#39;, () =&gt; { afterEach(() =&gt; { jest.restoreAllMocks(); });// â€¦ rest of tests});Quick Referencejest.restoreAllMocks()â€Šâ€”â€ŠRemove all mocks, restore original (mostÂ common)jest.clearAllMocks()â€Šâ€”â€ŠClear mock history, keep mocksÂ activejest.resetAllMocks()â€Šâ€”â€ŠClear history and implementation, keep spyÂ activeLessons LearnedWhen mock, clean upâ€Šâ€”â€ŠMake `afterEach` standardÂ practiceTest isolation mattersâ€Šâ€”â€ŠEach test should run independentlyPasses alone, fails in suite?â€Šâ€”â€ŠProbably mockÂ leakingLook upstreamâ€Šâ€”â€ŠThe problem might be in an earlierÂ test
