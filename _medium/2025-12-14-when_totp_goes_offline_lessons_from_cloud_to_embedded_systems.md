---
layout: default
title: "When TOTP Goes Offline: Lessons from Cloud to Embedded Systems"
date: Sun, 14 Dec 2025 07:32:43 +0000
excerpt: "Last week, I wrote about build"
link: "https://medium.com/@shiki65536/when-totp-goes-offline-lessons-from-cloud-to-embedded-systems-d3157ab7d104?source=rss-374d8f1302a3------2"
image: "https://cdn-images-1.medium.com/max/1024/1*ZbnPyGAvvubFmP033oyPyQ.png"
tags: ["totp", "embedded-systems", "otp-verification"]
---
Last week, I wrote about building a serverless TOTP solution for internal access. Coincidentally, my familiars just shared a side project that may use TOTP in a completely different context, and it refreshed my mental model of how TOTP should work.The scenario:A court booking system with smart locks. Users book online, get access codes, unlock the court.The twist:The locks are completely offline. No WiFi. Yet the password still changes dynamically, and users who book the court magically know the correct way to unlock.How does an offline lock stay synchronized with the server?Approach 1: Pure TOTP (What I First Assumed)This is the same tech behind Google Authenticator. Here’s the genius of it:The Setup:Lock and Server share a secret key (set during installation)Both have accurate clocksBoth run the same algorithm# Server (when user checks booking)otp = pyotp.TOTP(COURT_1_SECRET).now() # &quot;482916&quot;Both server side and lock side independently generate the same code because they share the same secret and both know what time it is. No communication needed.The catch:Clock drift kills this approach. After a few months, the lock’s time is off by 30+ seconds, which breaks the 30-second TOTP window.Approach 2: BLE/NFC Tokens (Alternate Solution)Instead of syncing passwords, sync encrypted tokens:The Setup:Lock and Server share a secret key (for token signature verification)Phone stores encrypted tokens from serverLock has BLE/NFC receiver to accept tokens# Server generates tokentoken = { &quot;booking_id&quot;: 123, &quot;valid_from&quot;: &quot;13:45&quot;, &quot;valid_until&quot;: &quot;15:15&quot;, &quot;signature&quot;: hmac_sha256(data, lock_secret)}Server generates unique tokens for each booking and signs them with the shared secret. Lock validates the signature offline, confirming the token, without needing to communicate back.The catch:Requires users to have smartphones. Can’t give temporary access to someone without a compatible device.The comparisonTime sensitivity: TOTP breaks at ±30s drift. Tokens tolerate ±15min drift.UX: typing 6 digits vs. Tap phone to unlockMaintenance: Lock’s clock vs. BLE connection passively syncsI still don’t know which approach my familiar chose, but after researching both, BLE tokens seem more practical. Commercial smart locks (Yale, August, Schlage) all use BLE/NFC + WiFi hybrids because maintenance overhead matters in production.— ReferencesTOTP Standards &amp; Implementations:RFC 6238 — TOTP SpecificationTOTP Algorithm ExplainedWhat is TOTPSmart Lock Products:Commercial Smart Lock Comparison
