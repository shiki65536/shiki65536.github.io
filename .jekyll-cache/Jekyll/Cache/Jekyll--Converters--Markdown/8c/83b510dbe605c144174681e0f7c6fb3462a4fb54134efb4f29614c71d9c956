I"<p>This week I hit a particularly nasty bug where tests passed individually but failed in the suite. Took me an entire afternoon to realize it was mock leaking. Writing this down for futureÂ me.The Symptom// Test 1: âœ… PASSdescribe('controlled load stays as TIME_OF_USE_CONT_LOAD', () =&gt; { it('should not map timezone', () =&gt; { jest.spyOn(module, 'getPricingModelFrom') .mockReturnValue('TIME_OF_USE_CONT_LOAD');  const result = planElectricityContractFrom(â€¦); expect(result.timeZone).toBeUndefined(); });});// Test 2: âŒ FAILdescribe('normal TIME_OF_USE', () =&gt; { it('should map timezone from tariff', () =&gt; { const result = planElectricityContractFrom(â€¦); expect(result.pricingModel).toEqual('TIME_OF_USE'); // Expected: "TIME_OF_USE" // Received: "TIME_OF_USE_CONT_LOAD" â† wait, what? });});Root CauseTest 1â€™s mock wasnâ€™t cleaned up and leaked into TestÂ 2:Test 1 runs â†’ Mock getPricingModelFrom()  â†’ Test 1 ends (but mock still active!) â†’ Test 2 runs (uses Test 1â€™s mock) â†’ Test 2 explodesÂ ğŸ’¥The FixAdd <code class="language-plaintext highlighter-rouge">afterEach</code> to clean upÂ mocks:describe('pricing model tests', () =&gt; { afterEach(() =&gt; { jest.restoreAllMocks(); });// â€¦ rest of tests});Quick Referencejest.restoreAllMocks()â€Šâ€”â€ŠRemove all mocks, restore original (mostÂ common)jest.clearAllMocks()â€Šâ€”â€ŠClear mock history, keep mocksÂ activejest.resetAllMocks()â€Šâ€”â€ŠClear history and implementation, keep spyÂ activeLessons LearnedWhen mock, clean upâ€Šâ€”â€ŠMake <code class="language-plaintext highlighter-rouge">afterEach</code> standardÂ practiceTest isolation mattersâ€Šâ€”â€ŠEach test should run independentlyPasses alone, fails in suite?â€Šâ€”â€ŠProbably mockÂ leakingLook upstreamâ€Šâ€”â€ŠThe problem might be in an earlierÂ test</p>
:ET